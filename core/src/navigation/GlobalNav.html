<svelte:window on:click="{closeAllDropdowns}" on:blur="{closeAllDropdowns}"/>
{#if showGlobalNav}
<div class="fd-shellbar__group fd-shellbar__group--actions">
  {#if children && pathData.length > 0}
  {#each children as node, i}
  {#if node.globalNav}
  <div
    class="fd-shellbar__action fd-shellbar__action--hide fd-shellbar__action--desktop"
  >
    <button
      title="{getNodeLabel(node)}"
      class="fd-shellbar__button fd-button {node === selectedNode ? 'is-selected' : ''}"
      aria-expanded="false"
      aria-haspopup="true"
      on:click="{() => handleClick(node)}"
      data-testid="{getTestId(node)}"
    >
      {#if node.icon}
      {#if hasOpenUIicon(node)}
      <span
        class="fd-top-nav__icon sap-icon--{node.icon}"
      ></span>
      {:else}
      <img
        class="fd-top-nav__icon nav-icon"
        src="{node.icon}"
        alt="{node.altText ? node.altText : ''}"
      >
      {/if}
      <!-- end hasOpenUIicon-->
      {/if}
      <!-- end node.icon -->
      {#if !node.icon || node.showLabel}
      <span>{getNodeLabel(node)}</span>
      {/if}
    </button>
  </div>

  {/if}
  {/each}
  {/if}
</div>
{/if}
<script>
  import {
    beforeUpdate,
    createEventDispatcher,
    onMount,
    getContext
  } from 'svelte';
  import { LuigiAuth, LuigiConfig, LuigiI18N } from '../core-api';
  import {
    NavigationHelpers,
    RoutingHelpers,
    StateHelpers,
    EventListenerHelpers
  } from '../utilities/helpers';

  const dispatch = createEventDispatcher();

  export let pathData;
  let previousPathData;
  export let pathParams;
  export let children;
  export let selectedNode;

  let store = getContext('store');
  let contextSwitcherConfig = LuigiConfig.getConfigValue(
    'navigation.contextSwitcher'
  );

  export let showGlobalNav;
  export let hideNavComponent;
  export let responsiveNavSetting;

  const setTopNavData = async () => {
    if (pathData && 0 < pathData.length) {
      const tnd = await NavigationHelpers.generateTopNavNodes(pathData);
      children = tnd.children;
      selectedNode = tnd.selectedNode;
      previousPathData = pathData;
    }
  };

  onMount(() => {
    StateHelpers.doOnStoreChange(
      store,
      () => {
        hideNavComponent = LuigiConfig.getConfigBooleanValue(
          'settings.hideNavigation'
        );
        responsiveNavSetting = LuigiConfig.getConfigValue(
          'settings.responsiveNavigation'
        );
        showGlobalNav = LuigiConfig.getConfigBooleanValue(
          'settings.globalSideNavigation'
        );
      },
      ['navigation']
    );
  });

  beforeUpdate(() => {
    if (!previousPathData || previousPathData != pathData) {
      setTopNavData();
    }
  });

  function hasOpenUIicon(node) {
    return NavigationHelpers.isOpenUIiconName(node.icon);
  }

  function getNodeLabel(node) {
    return LuigiI18N.getTranslation(node.label);
  }

  function getTestId(node) {
    return node.testId
      ? node.testId
      : NavigationHelpers.prepareForTests(node.pathSegment, node.label);
  }

  function getRouteLink(node) {
    return RoutingHelpers.getNodeHref(node, pathParams);
  }

  export function handleClick(node) {
    dispatch('handleClick', { node });
  }

  export function handleClickExternal(event) {
    handleClick(event.detail.node);
  }

  export function closeAllDropdowns() {
    // const ddStates = dropDownStates || {};
    // const keys = Object.keys(ddStates);
    // if (keys && keys.length > 0) {
    //   keys.forEach(k => {
    //     ddStates[k] = false;
    //     dropDownStates = ddStates;
    //   });
    // }
  }
</script>

<style type="text/scss">
  //remove default outline of all dropdowns in shellbar
  .fd-shellbar:focus {
    outline: none;
  }

  // Fix FD Styles for icons in Shellbar 0.11.2
  .fd-shellbar__button {
    .fd-top-nav__icon {
      color: var(--sapShell_TextColor, #fff);

      &:before {
        margin-top: 10px;
      }
    }
  }

  .hideNavComponent {
    display: none;
  }

  .nav-icon {
    height: 100%;
  }

  .fd-top-nav__icon {
    img {
      max-height: 16px;
      vertical-align: top;
      max-width: 16px;
    }
  }

  img {
    &.fd-top-nav__icon {
      height: 16px;
      min-width: auto;
    }
  }

  .fd-popover {
    .nav-icon {
      height: 2em;
    }
  }

  .lui-burger {
    margin-right: 16px;
    cursor: pointer;
    color: var(--sapShell_TextColor, #fff);
  }

  @media (min-width: 600px) {
    .lui-burger {
      margin-left: 0px;
    }
  }

  @media (min-width: 600px) {
    :global(.lui-mobileOnly) .lui-burger {
      display: none;
    }
  }

  :global(.no-side-nav) {
    .lui-burger {
      display: none;
    }
  }

  .fd-top-nav__icon {
    display: inline-block;
    vertical-align: middle;
    min-width: 16px;
  }

  .fd-popover__body {
    &.fd-popover__body--right {
      &:before,
      &:after {
        right: 14px;
      }
    }
  }
</style>
